<ng-container *ngIf="!mostrarFormularioNuevo; else nuevoMovimiento">
  <div #cuentaWrapper class="w-full flex items-center gap-4 mb-4 flex-wrap">
    <div class="relative">
      <input
        #cuentaInput
        class="w-64 px-2 py-2 bg-white border border-gray-300 rounded"
        id="cuenta"
        name="cuenta"
        placeholder="Selecciona una cuenta bancaria"
        autocomplete="off"
        (focus)="onInputFocus()"
        (input)="SeleccionarCuenta($event)"
      />

      <div *ngIf="showLista">
        <cdk-virtual-scroll-viewport
          itemSize="36"
          class="absolute z-50 left-0 top-full mt-1 bg-white border border-gray-200 rounded-md w-72 h-48 overflow-auto shadow-lg"
        >
          <div
            *cdkVirtualFor="let cuenta of filteredCuentas"
            class="px-4 py-2 cursor-pointer hover:bg-gray-100"
            style="height: 36px; box-sizing: border-box"
            (mousedown)="$event.preventDefault()"
            (click)="ElegirCuenta(cuenta)"
          >
            {{ cuenta.numeroCuenta }}
          </div>
        </cdk-virtual-scroll-viewport>
      </div>
    </div>

    <button
      *ngIf="cuentaSeleccionada"
      class="bg-colorButton text-[#f2f2f2] rounded-lg hover:bg-colorButtonHover transition-colors px-4 py-2"
      type="button"
      (click)="abrirModalMovimientoBancario()"
    >
      Nuevo movimiento bancario
    </button>

    <mat-form-field *ngIf="cuentaSeleccionada" class="min-w-[320px] mt-4">
      <mat-date-range-input [formGroup]="range" [rangePicker]="picker">
        <input matStartDate formControlName="start" placeholder="Fecha inicial" />
        <input matEndDate formControlName="end" placeholder="Fecha final" />
      </mat-date-range-input>
      <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-date-range-picker #picker>
        <mat-date-range-picker-actions>
          <button mat-button matDateRangePickerCancel>Cancelar</button>
          <button mat-button matDateRangePickerCancel (click)="limpiarFiltro()">Limpiar</button>
          <button
            mat-raised-button
            color="primary"
            (click)="clickButtonFiltro()"
            matDateRangePickerApply
          >
            Filtrar
          </button>
        </mat-date-range-picker-actions>
      </mat-date-range-picker>
    </mat-form-field>
  </div>

  <div
    *ngIf="!cuentaSeleccionada"
    class="px-2 py-4 bg-white mt-3 rounded-lg border border-gray200 flex justify-center"
  >
    <div class="text-center space-y-2">
      <p class="text-base text-gray-600 font-medium m-0">Selecciona una cuenta bancaria.</p>
      <p class="text-sm text-gray-400 m-0">
        Usa el buscador para encontrar la cuenta y visualizar sus movimientos.
      </p>
    </div>
  </div>

  <ng-container *ngIf="cuentaSeleccionada">
    <div class="overflow-x-auto shadow-md rounded-lg">
      <table class="w-full text-sm xs:table-fixed">
        <thead class="bg-primario text-white">
          <tr class="xs:text-[10px]">
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">No. Movimiento</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Folio</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Fecha alta</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Fecha aplicacion</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Fecha cobro</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Modalidad</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Deposito</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Retiro</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Saldo</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Moneda</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Tipo cambio</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Concepto</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Beneficiario</th>
            <th class="px-1 py-[2px] xs:w-[75px]" scope="col">Estatus</th>
            <th class="px-1 py-[2px] text-center" scope="col">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray300">
          <tr
            *ngFor="let mb of moviminestosbancarios"
            class="font-medium text-gray700 hover:bg-gray200 animation duration-200 xs:text-[8px]"
          >
            <td class="px-1 py-[2px]" scope="col">{{ mb.noMovimientoBancario }}</td>
            <td class="px-1 py-[2px]" scope="col">{{ mb.folio }}</td>
            <td class="px-1 py-[2px]" scope="col">{{ mb.fechaAlta | date: 'dd-MM-yyyy' }}</td>
            <td class="px-1 py-[2px]" scope="col">{{ mb.fechaAplicacion | date: 'dd-MM-yyyy' }}</td>
            <td class="px-1 py-[2px]" scope="col">{{ mb.fechaCobra | date: 'dd-MM-yyyy' }}</td>
            <td class="px-1 py-[2px]" scope="col">{{ mb.descripcionModalidad }}</td>
            <td class="px-1 py-[2px]" scope="col">
              {{ mb.tipoDeposito == 1 ? '$ ' + (mb.montoTotal | number: '1.2-2') : '-' }}
            </td>
            <td class="px-1 py-[2px]" scope="col">
              {{ mb.tipoDeposito == 2 ? '$' + (mb.montoTotal | number: '1.2-2') : '-' }}
            </td>
            <td class="px-1 py-[2px]" scope="col">${{ mb.saldo | number: '1.2-2' }}</td>
            <td class="px-1 py-[2px]" scope="col">{{ mb.descripcionMoneda }}</td>
            <td class="px-1 py-[2px]" scope="col">${{ mb.tipoCambio | number: '1.2-2' }}</td>
            <td class="px-1 py-[2px]" scope="col">{{ mb.concepto }}</td>
            <td class="px-1 py-[2px]" scope="col">{{ mb.beneficiario }}</td>
            <td class="px-1 py-[2px]" scope="col">{{ mb.descripcionEstatus }}</td>
            <td class="px-1 py-[2px]" scope="col">
              <div class="flex gap-1 justify-center" *ngIf="mb.estatus != 2">
                <button
                  class="w-full bg-colorButton text-white py-1 px-1 rounded-md hover:bg-colorButtonHover transition-colors"
                  *ngIf="mb.estatus != 1"
                  (click)="autorizarMovimientoBancario(mb.id)"
                >
                  Autorizar
                </button>

                <button
                  class="w-full bg-colorButton text-white py-1 px-1 rounded-md hover:bg-colorButtonHover transition-colors"
                  *ngIf="mb.estatus == 0"
                  (click)="cancelarMovimientoBancario(mb.id)"
                >
                  Cancelar
                </button>

                <button
                  class="w-full bg-colorButton text-white py-1 px-1 rounded-md hover:bg-colorButtonHover transition-colors"
                  *ngIf="mb.estatus == 1 && (mb.idPoliza == 0 || mb.idPoliza == null)"
                  (click)="generarPoliza(mb.id)"
                >
                  Crear poliza
                </button>

                <button
                  class="w-full bg-colorButton text-white py-1 px-1 rounded-md hover:bg-colorButtonHover transition-colors"
                  *ngIf="mb.idPoliza > 0"
                  (click)="eliminarPoliza(mb.id)"
                >
                  Eliminar poliza
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>
</ng-container>

<ng-template #nuevoMovimiento>
  <div class="space-y-4">
    <app-nuevo-movimiento-bancario
      [empresaId]="selectedEmpresa"
      [cuentaBancariaEmpresaId]="idCuentaBancaria"
      (closed)="cerrarFormularioNuevoMovimiento($event)"
    ></app-nuevo-movimiento-bancario>
  </div>
</ng-template>
