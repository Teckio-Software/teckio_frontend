<ng-container *ngIf="!mostrarFormularioMovimientoBancario; else nuevoMovimiento">
  <section class="p-2">
  <div class="bg-white rounded-md w-full" *ngIf="!crearCuenta && !verCuenta">
    <div class="flex items-center gap-3 px-3 py-2 ">
      <div class="relative">
        <img
          src="./assets/search.svg"
          alt="Buscar"
          class="w-4 h-4 absolute inset-y-0 left-2 my-auto text-gray-500 pointer-events-none"
        />
        <input
          class="w-64 pl-8 pr-2 py-2 bg-gris border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black"
          id="cuenta"
          name="cuenta"
          placeholder="Seleccione un Proveedor"
          autocomplete="off"
          (input)="filtrarProveedor($event)"
          (click)="mostrarListaProveedor = !mostrarListaProveedor"
          [(ngModel)]="proveedorRazonSocial"
        />
          <div *ngIf="mostrarListaProveedor">
                    <cdk-virtual-scroll-viewport
                      itemSize="36"
                      class="fixed z-50 bg-white border border-gray-200 rounded-md mt-1 w-[300px] h-36 overflow-auto shadow-lg"
                    >
                      <div
                        *cdkVirtualFor="let proveedor of listaProveedores"
                        (click)="seleccionarProveedor(proveedor)"
                        class="px-4 py-2 cursor-pointer hover:bg-gray-100"
                        style="height: 36px; box-sizing: border-box"
                      >
                        {{ proveedor }}
                      </div>
                    </cdk-virtual-scroll-viewport>
                  </div>
      </div>
      <select
        class="bg-gris border border-[#929292] text-[#929292] text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 px-3 py-2 w-48 min-w-fit"
        (input)="seleccionEstatus($event)"
      >
        <option value="">Estatus</option>
        <option value="1">Pendiente</option>
        <option value="2">Saldado parcialmente</option>
      </select>

      <input
          type="date"
          ngbTooltip="Fecha de inicio"
          [(ngModel)]="fechaInicio"
          (change)="filtrarTablaOrdenesVentaPorCobrar()"
          class="bg-gris border border-[#929292] text-[#929292] text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 px-3 py-2 w-40 min-w-fit"
        />
        <input
          type="date"
          ngbTooltip="Fecha de termino"
          [(ngModel)]="fechaFin"
          (change)="filtrarTablaOrdenesVentaPorCobrar()"
          class="bg-gris border border-[#929292] text-[#929292] text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 px-3 py-2 w-40 min-w-fit"
        />

        <div class="flex items-center">
          <button (click)="limpiarFiltros()" class="w-7 h-7">
            <img src="assets/delete filter.svg" alt="botón agregar" />
          </button>
        </div>
    </div>

    <table class="w-full mt-4 text-center">
      <thead class="text-center bg-[#f9fafb]">
        <th class="py-3 font-medium">No. Orden de compra</th>
        <th class="py-3 font-medium">Proveedor</th>
        <th class="py-3 font-medium">Monto total</th>
        <th class="py-3 font-medium">Monto pagado</th>
        <th class="py-3 font-medium">Saldo pendiente</th>
        <th class="py-3 font-medium">Fecha vencimiento</th>
        <th class="py-3 font-medium">Estatus</th>
        <th class="py-3 font-medium">Acciones</th>
      </thead>
      <tbody class="divide-y divide-gray300">
        <tr class="font-medium text-gray700 hover:bg-gris animation duration-200 xs:text-[8px]" *ngFor="let oc of ordenesCompraPorPagar">
          <td class="py-4">{{oc.noOrdenCompra}}</td>
          <td class="py-4">{{oc.razonSocial}}</td>
          <td class="py-4">{{oc.importeTotal| currency}}</td>
          <td class="py-4">{{ (oc.importeTotal - oc.saldo) | currency }}</td>
          <td class="py-4">{{oc.saldo | currency}}</td>
          <td class="py-4">{{oc.fechaRegistro | date : "dd/MM/yyyy"}}</td>
          <td class="py-4">
            <div class="flex justify-center">
              <div
                    class="bg-amber50 rounded-lg w-28 h-5"
                    *ngIf="oc.estatusSaldado === 1"
                  >
                    <p class="text-amber500 text-center">Pendiente</p>
                  </div>
                  <div
                    class="bg-blue100 rounded-lg w-48 h-5"
                    *ngIf="
                      oc.estatusSaldado === 2
                    "
                  >
                    <p class="text-blue600 text-center">Saldado parcialmente</p>
                  </div>
                  <div
                    class="bg-green100 rounded-lg w-48 h-5"
                    *ngIf="
                      oc.estatusSaldado === 3
                    "
                  >
                    <p class="text-green600 text-center">Saldado totalmente</p>
                  </div>
            </div>
          </td>
          <td class="py-4">
            <div class="flex justify-center gap-3">
                  <div>
                    <img
                      ngbTooltip="Cargar facturas"
                      triggers="mouseenter:mouseleave"
                      class="cursor-pointer mx-auto xs:w-4"
                      src="./assets/upload_file.svg"
                      alt="Cargar facturas"
                      (click)="nuevaFacturaOrdenCompra(oc.id)"
                    />
                  </div>
                  <button (click)="abrirModalMovimientoBancario(oc)">
                <img src="./assets/arrow-right-solid-full.svg" alt="Botón de ver" class="w-5" />
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
</ng-container>

<app-nueva-cuenta *ngIf="crearCuenta" (regresar)="crearCuenta = false"></app-nueva-cuenta>
<app-ver-cuenta *ngIf="verCuenta" (regresar)="verCuenta = false"></app-ver-cuenta>

<ng-template #dialogNuevaFactura>
  <div
    class="fixed inset-0 z-10 w-screen overflow-y-auto"
    (click)="limpiarCargarFactura()"
  >
    <div
      class="content-center sm:flex min-h-full items-cen justify-center p-4 text-center sm:items-center sm:p-0"
    >
      <!-- Evita que el clic se propague al contenedor padre (overlay) -->

      <div
        class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl"
        (click)="detenerCierre($event)"
      >
        <!-- detenerCierre(event: MouseEvent): Método que detiene la propagación del evento de clic cuando se hace clic dentro del contenido del modal, asegurando que el modal no se cierre inadvertidamente. -->
        <div class="px-9 mt-4 mb-1 flex justify-between">
          <h2 class="font-normal tracking-[2px] leading-8 text-base">
            Nueva Validación
          </h2>
          <button
            type="button"
            class="leading-none absolute top-0 right-0 px-4 py-3 text-2xl"
            (click)="limpiarCargarFactura()"
          >
            &times;
          </button>
        </div>
        <div class="bg-white px-4 pb-4 sm:p-2 sm:pb-4">
          <div>
            <div class="overflow-x-auto whitespace-nowrap w-full m-auto mt-1">
              <div class="mb-3 flex">
                <input
                  type="file"
                  class="form-control text-gray-700"
                  multiple
                  (change)="onFileChangeFactura($event)"
                />
                <div
                  class="border-2 bg-colorButton rounded-lg p-2 hover:border-blue-200 transition-all duration-300 cursor-pointer"
                  ngbTooltip="Cargar factura"
                  triggers="mouseenter:mouseleave"
                >
                  <img
                    src="./assets/check_circle.svg"
                    alt=""
                    (click)="cargarFactura()"
                  />
                </div>
              </div>
              <div>
                <div class="rounded-lg shadow-md overflow-hidden mb-4">
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm xs:table-fixed">
                      <thead class="bg-primario text-white">
                        <tr class="xs:text-[10px]">
                          <th class="px-1 py-[2px]" scope="col">
                            Total Orden Compra
                          </th>
                          <th class="px-[2px] py-[2px]" scope="col">
                            Total Facturado
                          </th>
                          <th class="px-[2px] py-[2px]" scope="col">Estatus</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray300">
                        <ng-container>
                          <tr
                            class="font-medium text-gray700 hover:bg-gray200 animation duration-200 xs:text-[8px]"
                          >
                            <td class="px-1 py-[2px]" scope="col">
                              {{ ordenCompraFacturas.montoTotalOrdenCompra }}
                            </td>
                            <td class="px-1 py-[2px]" scope="col">
                              {{ ordenCompraFacturas.montoTotalFactura }}
                            </td>
                            <td class="px-1 py-[2px]" scope="col">
                              <div class="flex justify-center h-full">
                                <div
                                  class="bg-blue100 rounded-lg w-28 h-5"
                                  *ngIf="
                                    ordenCompraFacturas.estatusSaldado === 1
                                  "
                                >
                                  <p class="text-blue600 text-center">
                                    Pendiente por pagar
                                  </p>
                                </div>
                                <div
                                  class="bg-blue100 rounded-lg w-28 h-5"
                                  *ngIf="
                                    ordenCompraFacturas.estatusSaldado === 1
                                  "
                                >
                                  <p class="text-blue600 text-center">
                                    Pendiente por pagar
                                  </p>
                                </div>
                                <div
                                  class="bg-green100 rounded-lg w-28 h-5"
                                  *ngIf="
                                    ordenCompraFacturas.estatusSaldado === 2
                                  "
                                >
                                  <p class="text-green600 text-center">
                                    Pagada Parcialmente
                                  </p>
                                </div>
                                <div
                                  class="bg-green100 rounded-lg w-28 h-5"
                                  *ngIf="
                                    ordenCompraFacturas.estatusSaldado === 3
                                  "
                                >
                                  <p class="text-green600 text-center">
                                    Pagada totalmente
                                  </p>
                                </div>
                              </div>
                            </td>
                          </tr>
                        </ng-container>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div>
                  <div class="rounded-lg shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                      <table class="w-full text-sm xs:table-fixed">
                        <thead class="bg-primario text-white">
                          <tr class="xs:text-[10px]">
                            <th class="px-1 py-[2px]" scope="col">Uuid</th>
                            <th class="px-1 py-[2px]" scope="col">
                              Fecha emision
                            </th>
                            <th class="px-1 py-[2px]" scope="col">Total</th>
                            <th class="px-1 py-[2px] text-center" scope="col">
                              Estatus
                            </th>
                            <th
                              class="px-1 py-[2px] text-center"
                              scope="col"
                            ></th>
                          </tr>
                        </thead>
                        <tbody class="divide-y divide-gray300">
                          <ng-container
                            *ngFor="
                              let fxoc of ordenCompraFacturas.facturasXOrdenCompra
                            "
                          >
                            <tr
                              class="font-medium text-gray700 hover:bg-gray200 animation duration-200 xs:text-[8px]"
                            >
                              <td
                                class="px-1 py-[2px]"
                                scope="col"
                                (click)="facturaDetalleSelected(fxoc)"
                              >
                                {{ fxoc.uuid }}
                              </td>
                              <td class="px-1 py-[2px]" scope="col">
                                {{ fxoc.fechaEmision }}
                              </td>
                              <td class="px-1 py-[2px]" scope="col">
                                {{ fxoc.total }}
                              </td>
                              <td class="px-1 py-[2px]" scope="col">
                                <!-- {{ fxoc.estatus }} -->
                                <div class="flex justify-center h-full">
                                  <div
                                    class="bg-blue100 rounded-lg w-28 h-5"
                                    *ngIf="fxoc.estatus === 1"
                                  >
                                    <p class="text-blue600 text-center">
                                      Capturada
                                    </p>
                                  </div>
                                  <div
                                    class="bg-green100 rounded-lg w-28 h-5"
                                    *ngIf="fxoc.estatus === 2"
                                  >
                                    <p class="text-green600 text-center">
                                      Autorizada
                                    </p>
                                  </div>
                                  <div
                                    class="bg-green100 rounded-lg w-28 h-5"
                                    *ngIf="fxoc.estatus === 3"
                                  >
                                    <p class="text-green600 text-center">
                                      Pagada parcialmente
                                    </p>
                                  </div>
                                  <div
                                    class="bg-green100 rounded-lg w-28 h-5"
                                    *ngIf="fxoc.estatus === 4"
                                  >
                                    <p class="text-green600 text-center">
                                      Pagada totalmente
                                    </p>
                                  </div>
                                  <div
                                    class="bg-green100 rounded-lg w-28 h-5"
                                    *ngIf="fxoc.estatus === 5"
                                  >
                                    <p class="text-green600 text-center">
                                      Cancelada
                                    </p>
                                  </div>
                                </div>
                              </td>
                              <td class="px-1 py-[2px]" scope="col">
                                <div class="flex">
                                  <img
                                    (click)="autorizarFactura(fxoc)"
                                    *ngIf="fxoc.estatus == 1"
                                    src="./assets/authorize_facture.svg"
                                    alt=""
                                    class="cursor-pointer mx-auto"
                                    ngbTooltip="Autorizar"
                                    triggers="mouseenter:mouseleave"
                                  />
                                  <img
                                    (click)="cancelarFactura(fxoc)"
                                    *ngIf="fxoc.estatus == 1"
                                    src="./assets/authorize_facture.svg"
                                    alt=""
                                    class="cursor-pointer mx-auto"
                                    ngbTooltip="Cancelar"
                                    triggers="mouseenter:mouseleave"
                                  />
                                </div>
                              </td>
                            </tr>
                          </ng-container>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <div *ngIf="detalleFacturaXOC.length > 0">
                  <div class="rounded-lg shadow-md overflow-hidden mt-4">
                    <div class="overflow-x-auto">
                      <table class="w-full text-sm xs:table-fixed">
                        <thead class="bg-primario text-white">
                          <tr class="xs:text-[10px]">
                            <th class="px-1 py-[2px]" scope="col">
                              Descripcion
                            </th>
                            <th class="px-1 py-[2px]" scope="col">Unidad</th>
                            <th class="px-1 py-[2px]" scope="col">Cantidad</th>
                            <th class="px-1 py-[2px]" scope="col">
                              Precion unitario
                            </th>
                            <th class="px-1 py-[2px]" scope="col">Descuento</th>
                            <th class="px-1 py-[2px]" scope="col">Importe</th>
                          </tr>
                        </thead>
                        <tbody class="divide-y divide-gray300">
                          <ng-container
                            *ngFor="let detFactura of detalleFacturaXOC"
                          >
                            <tr
                              class="font-medium text-gray700 hover:bg-gray200 animation duration-200 xs:text-[8px]"
                            >
                              <td class="px-1 py-[2px]" scope="col">
                                {{ detFactura.descripcion }}
                              </td>
                              <td class="px-1 py-[2px]" scope="col">
                                {{ detFactura.unidadSat }}
                              </td>
                              <td class="px-1 py-[2px]" scope="col">
                                {{ detFactura.cantidad }}
                              </td>
                              <td class="px-1 py-[2px]" scope="col">
                                {{ detFactura.precioUnitario }}
                              </td>
                              <td class="px-1 py-[2px]" scope="col">
                                {{ detFactura.descuento }}
                              </td>
                              <td class="px-1 py-[2px]" scope="col">
                                {{ detFactura.importe }}
                              </td>
                            </tr>
                          </ng-container>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-gray-50 px-2 py-2 flex justify-end gap-4">
          <button
            class="rounded-md px-4 py-2 bg-colorButton transition-all duration-300 text-white text-sm shadow-sm hover:bg-colorButtonHover"
            (click)="limpiarCargarFactura()"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #nuevoMovimiento>
  <div class="space-y-4">
    <app-nuevo-movimiento-bancario
      [empresaId]="selectedEmpresa"
      [idProveedor]="IdProveedor"
      [idOrdenCompra]="IdOrdenCompraSeleccionada"
      (closed)="cerrarFormularioNuevoMovimiento($event)"
    ></app-nuevo-movimiento-bancario>
  </div>
</ng-template>
