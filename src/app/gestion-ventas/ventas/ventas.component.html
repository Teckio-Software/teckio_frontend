<section>
  <div>
    <div>
      <!-- Button cotainer -->
      <div class="flex mt-1 mb-2">
        <button
          (click)="crearOrdenVenta()"
          class="flex align-items-center rounded-md bg-colorButton transition-colors delay-75 hover:bg-colorButtonHover font-light text-white p-1"
        >
          <p
            class="text-[#f2f2f2] titular bg-custom-bg w-52 font-medium text-base tracking-wider m-0 text-center xs:text-[10px] xs:w-24"
          >
            Nueva venta
          </p>
          <img class="xs:w-4" src="assets/add.svg" alt="botón agregar" />
        </button>
      </div>
      <!-- Button cotainer  end -->

      <p class="text-sm font-medium mb-2 text-gray700 xs:text-[10px]">
        Campos obligatorios marcados con <span class="font-bold">*</span>
      </p>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto shadow-md rounded-lg">
      <!-- Table container -->
      <div>
        <table class="w-full text-sm xs:table-fixed">
          <thead class="bg-primario text-white">
            <tr class="xs:text-[10px]">
              <th scope="col" class="px-1 py-[2px] xs:w-[75px]">Venta no.</th>
              <th scope="col" class="px-[2px] py-[2px] xs:w-[70px]">Elaboró</th>
              <th scope="col" class="px-[2px] py-[2px] xs:w-[75px]">
                Registro
              </th>
              <th scope="col" class="px-[2px] py-[2px] xs:w-[70px]">Accion</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray300">
            <ng-container>
              <ng-container *ngIf="isLoading">
                <tr>
                  <!-- Venta no. -->
                  <td class="px-1" scope="col">
                    <div role="status" class="max-w-sm animate-pulse">
                      <div
                        class="h-5 bg-gray300 rounded-full w-28 xs:w-14 xs:h-3 mt-1 mb-1"
                      ></div>
                    </div>
                  </td>
                  <!-- Elaboró -->
                  <td scope="col">
                    <div role="status" class="max-w-sm animate-pulse">
                      <div
                        class="h-5 bg-gray300 rounded-full w-40 xs:w-14 xs:h-3 mt-1 mb-1"
                      ></div>
                    </div>
                  </td>
                  <!-- Registro -->
                  <td scope="col">
                    <div role="status" class="max-w-sm animate-pulse">
                      <div
                        class="h-5 bg-gray300 rounded-full w-40 xs:w-14 xs:h-3 mt-1 mb-1"
                      ></div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <!-- Venta no. -->
                  <td class="px-1" scope="col">
                    <div role="status" class="max-w-sm animate-pulse">
                      <div
                        class="h-5 bg-gray300 rounded-full w-28 xs:w-14 xs:h-3 mt-1 mb-1"
                      ></div>
                    </div>
                  </td>
                  <!-- Elaboró -->
                  <td scope="col">
                    <div role="status" class="max-w-sm animate-pulse">
                      <div
                        class="h-5 bg-gray300 rounded-full w-40 xs:w-14 xs:h-3 mt-1 mb-1"
                      ></div>
                    </div>
                  </td>
                  <!-- Registro -->
                  <td scope="col">
                    <div role="status" class="max-w-sm animate-pulse">
                      <div
                        class="h-5 bg-gray300 rounded-full w-40 xs:w-14 xs:h-3 mt-1 mb-1"
                      ></div>
                    </div>
                  </td>
                </tr>
                <tr>
                  <!-- Venta no. -->
                  <td class="px-1" scope="col">
                    <div role="status" class="max-w-sm animate-pulse">
                      <div
                        class="h-5 bg-gray300 rounded-full w-28 xs:w-14 xs:h-3 mt-1 mb-1"
                      ></div>
                    </div>
                  </td>
                  <!-- Elaboró -->
                  <td scope="col">
                    <div role="status" class="max-w-sm animate-pulse">
                      <div
                        class="h-5 bg-gray300 rounded-full w-40 xs:w-14 xs:h-3 mt-1 mb-1"
                      ></div>
                    </div>
                  </td>
                  <!-- Registro -->
                  <td scope="col">
                    <div role="status" class="max-w-sm animate-pulse">
                      <div
                        class="h-5 bg-gray300 rounded-full w-40 xs:w-14 xs:h-3 mt-1 mb-1"
                      ></div>
                    </div>
                  </td>
                </tr>
              </ng-container>
              <tr
                class="font-medium text-gray700 hover:bg-gray200 animation duration-200 xs:text-[8px]"
                *ngFor="let orden of ordenesVenta"
              >
                <td class="px-1 py-[2px]" scope="col">
                  {{ orden.numeroOrdenVenta }}
                </td>
                <td class="px-1 py-[2px]" scope="col">{{ orden.elaboro }}</td>
                <td class="px-1 py-[2px]" scope="col">
                  {{ orden.fechaRegistro | date : "dd/MM/yyyy HH:mm:ss" }}
                </td>
                <td class="px-1 py-[2px]" scope="col">
                  <div class="flex gap-2">
                    <button>
                      <img
                        ngbTooltip="Ver detalles"
                        triggers="mouseenter:mouseleave"
                        class="cursor-pointer"
                        src="./assets/visibility_btn.svg"
                        alt="ver detalles"
                        (click)="openModal(orden)"
                      />
                    </button>
                    <button>
                      <img
                        ngbTooltip="Cancelar"
                        triggers="mouseenter:mouseleave"
                        class="cursor-pointer w-6"
                        src="./assets/cancel.svg"
                        alt="eliminar"
                        (click)="cancelarOrdenVenta(orden.id)"
                      />
                    </button>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<section>
  <div
    class="fixed inset-0 z-10 w-screen overflow-y-auto"
    *ngIf="isModalOpen"
    (click)="closeModal()"
  >
    <div
      class="content-center sm:flex min-h-full items-center justify-center p-4 text-center sm:items-center sm:p-0"
    >
      <div
        class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl"
        (click)="detenerCierre($event)"
      >
        <!-- Cabecera -->
        <div
          class="bg-white px-4 pb-2 pt-2 sm:p-6 sm:pb-4 flex justify-between border-b-2"
        >
          <h2 class="font-semibold text-gray-800 tracking-wider text-lg mt-3">
            Orden de Venta
          </h2>
          <button
            type="button"
            class="leading-none text-2xl px-3 py-1 text-gray-500 hover:text-gray-700"
            (click)="closeModal()"
          >
            &times;
          </button>
        </div>

        <!-- contenido -->
        <div class="bg-white px-4 pb-4 pt-2 sm:p-6 sm:pb-4">
          <div>
            <div class="mb-3">
              <label
                class="block text-sm font-medium text-gray-700 mb-1"
                for="almacen"
                >Cliente</label
              >
              <div class="relative w-full" #lista>
                <input
                  type="text"
                  placeholder="Seleccionar..."
                  autocomplete="off"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                  (input)="filtrarCliente($event)"
                  (keydown.enter)="guardarOrdenVenta()"
                  (click)="listaClientes = !listaClientes"
                  [(ngModel)]="this.ordenVenta.razonSocialCliente"
                />
                <div *ngIf="listaClientes">
                  <cdk-virtual-scroll-viewport
                    itemSize="36"
                    class="fixed z-50 bg-white border border-gray-200 rounded-md mt-1 w-[300px] h-36 overflow-auto shadow-lg"
                  >
                    <div
                      *cdkVirtualFor="let cliente of clientes"
                      (click)="seleccionarCliente(cliente)"
                      class="px-4 py-2 cursor-pointer hover:bg-gray-100"
                      style="height: 36px; box-sizing: border-box"
                    >
                      {{ cliente.razonSocial }}
                    </div>
                  </cdk-virtual-scroll-viewport>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label
                class="block text-sm font-medium text-gray-700"
                for="almacen"
                >Observaciones</label
              >
              <textarea
                name=""
                id=""
                [(ngModel)]="ordenVenta.observaciones"
                rows="2"
                (keydown.enter)="guardarOrdenVenta()"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
              ></textarea>
            </div>
            <div class="mb-3">
              <!-- <button
                (click)="agregarDetalle()"
                class="flex align-items-center rounded-md bg-colorButton transition-colors delay-75 hover:bg-colorButtonHover font-light text-white p-1"
              >
                <p
                  class="text-[#f2f2f2] titular bg-custom-bg w-52 font-medium text-base tracking-wider m-0 text-center xs:text-[10px] xs:w-24"
                >
                  Agregar Producto
                </p>
                <img class="xs:w-4" src="assets/add.svg" alt="botón agregar" />
              </button> -->
              <div class="flex gap-4 items-center">
                <p class="text-red-600 font-normal text-xs m-0">
                  {{ mensajeAlerta }}
                </p>
                <div class="flex gap-4">
                  <button
                    *ngIf="esEliminar"
                    class="text-red-600 font-normal text-xs underline"
                    (click)="eliminarRegistro()"
                  >
                    Si
                  </button>
                  <button
                    *ngIf="esEliminar"
                    class="text-red-600 font-normal text-xs underline"
                    (click)="noEliminar()"
                  >
                    No
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div>
            <div class="rounded-lg shadow-md overflow-hidden">
              <div class="overflow-y-auto max-h-[150px] w-full">
                <table class="w-full text-sm">
                  <thead class="bg-primario text-white sticky top-0">
                    <tr class="xs:text-[10px]">
                      <th class="px-1 py-[2px] w-[40%]" scope="col">
                        *Producto/Servicion
                      </th>
                      <th class="px-1 py-[2px] w-[15%]" scope="col">
                        *Cantidad
                      </th>
                      <th class="px-1 py-[2px] w-[15%]" scope="col">
                        *PrecioUnitario
                      </th>
                      <th class="px-1 py-[2px] w-[15%]" scope="col">
                        Descuento
                      </th>
                      <th class="px-1 py-[2px] w-[15%]" scope="col"></th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray300">
                    <tr
                      class="font-medium text-gray700 hover:bg-gray200 animation duration-200 xs:text-[8px]"
                    >
                      <td class="px-1 py-[2px] w-[40%]" scope="col">
                        <div class="relative w-full" #lista>
                          <input
                            type="text"
                            placeholder="Seleccionar..."
                            autocomplete="off"
                            class="form-contrtrol w-full"
                            (input)="filtrarProducto($event)"
                            (keydown.enter)="
                              guardarDetalle(nuevoDetalleOrdenVenta)
                            "
                            (click)="
                              listaProductoYServicio = !listaProductoYServicio
                            "
                            [(ngModel)]="nuevoDetalleOrdenVenta.descripcion"
                            [disabled]="esEliminar"
                          />
                          <div *ngIf="listaProductoYServicio">
                            <cdk-virtual-scroll-viewport
                              itemSize="36"
                              class="fixed z-50 bg-white border border-gray-200 rounded-md mt-1 w-[300px] h-32 overflow-auto shadow-lg"
                            >
                              <div
                                *cdkVirtualFor="
                                  let productoServicio of productosYServicio
                                "
                                (click)="seleccionarProducto(productoServicio)"
                                class="px-4 py-2 cursor-pointer hover:bg-gray-100"
                                style="height: 36px; box-sizing: border-box"
                              >
                                {{ productoServicio.descripcion }}
                              </div>
                            </cdk-virtual-scroll-viewport>
                          </div>
                        </div>
                      </td>
                      <td class="px-1 py-[2px] w-[15%]" scope="col">
                        <input
                          min="1"
                          placeholder="Cantidad..."
                          autocomplete="off"
                          class="dropdown1 bg-transparent w-[75%] xs:w-[100%] text-right"
                          type="number"
                          data-bs-toggle="dropdown"
                          [(ngModel)]="nuevoDetalleOrdenVenta.cantitdad"
                          (keydown.enter)="
                            guardarDetalle(nuevoDetalleOrdenVenta)
                          "
                        />
                      </td>
                      <td class="px-1 py-[2px] w-[15%]" scope="col">
                        <input
                          min="1"
                          placeholder="Cantidad..."
                          autocomplete="off"
                          class="dropdown1 bg-transparent w-[75%] xs:w-[100%] text-right"
                          type="number"
                          data-bs-toggle="dropdown"
                          [(ngModel)]="nuevoDetalleOrdenVenta.precioUnitario"
                          (keydown.enter)="
                            guardarDetalle(nuevoDetalleOrdenVenta)
                          "
                        />
                      </td>
                      <td class="px-1 py-[2px] w-[15%]" scope="col">
                        <input
                          min="1"
                          placeholder="Cantidad..."
                          autocomplete="off"
                          class="dropdown1 bg-transparent w-[75%] xs:w-[100%] text-right"
                          type="number"
                          data-bs-toggle="dropdown"
                          [(ngModel)]="nuevoDetalleOrdenVenta.descuento"
                          (keydown.enter)="
                            guardarDetalle(nuevoDetalleOrdenVenta)
                          "
                        />
                      </td>
                      <td class="px-1 py-[2px] w-[15%]" scope="col"></td>
                    </tr>
                    <ng-container
                      *ngFor="
                        let detalle of ordenVenta.detalleOrdenVenta;
                        let i = index
                      "
                    >
                      <tr
                        class="font-medium text-gray700 hover:bg-gray200 animation duration-200 xs:text-[8px]"
                        [ngClass]="{
                          'change-background-color':
                            detalle == selectedDetalleOrdenVenta
                        }"
                        (click)="selectedDetalleOrdenVenta = detalle"
                      >
                        <td class="px-1 py-[2px] w-[40%]" scope="col">
                          <div class="relative w-full">
                            <input
                              type="text"
                              placeholder="Seleccionar..."
                              autocomplete="off"
                              class="form-contrtrol w-full"
                              [(ngModel)]="detalle.descripcion"
                              readonly
                              [disabled]="esEliminar"
                            />
                          </div>
                        </td>
                        <td class="px-1 py-[2px] w-[15%]" scope="col">
                          <input
                            min="1"
                            placeholder="Cantidad..."
                            autocomplete="off"
                            class="dropdown1 bg-transparent w-[75%] xs:w-[100%] text-right"
                            type="number"
                            data-bs-toggle="dropdown"
                            (keydown.enter)="
                              guardarDetalle(nuevoDetalleOrdenVenta)
                            "
                            [(ngModel)]="detalle.cantitdad"
                            [disabled]="esEliminar"
                          />
                        </td>
                        <td class="px-1 py-[2px] w-[15%]" scope="col">
                          <input
                            min="1"
                            placeholder="Cantidad..."
                            autocomplete="off"
                            class="dropdown1 bg-transparent w-[75%] xs:w-[100%] text-right"
                            type="number"
                            data-bs-toggle="dropdown"
                            (keydown.enter)="
                              guardarDetalle(nuevoDetalleOrdenVenta)
                            "
                            [(ngModel)]="detalle.precioUnitario"
                            [disabled]="esEliminar"
                          />
                        </td>
                        <td class="px-1 py-[2px] w-[15%]" scope="col">
                          <input
                            min="1"
                            placeholder="Cantidad..."
                            autocomplete="off"
                            class="dropdown1 bg-transparent w-[75%] xs:w-[100%] text-right"
                            type="number"
                            data-bs-toggle="dropdown"
                            (keydown.enter)="
                              guardarDetalle(nuevoDetalleOrdenVenta)
                            "
                            [(ngModel)]="detalle.descuento"
                            [disabled]="esEliminar"
                          />
                        </td>
                        <td class="px-1 py-[2px] w-[15%]" scope="col">
                          <div class="flex gap-2">
                            <button
                              ngbTooltip="Ver Impuestos"
                              triggers="mouseenter:mouseleave"
                              (click)="verImpuestos(detalle)"
                              [disabled]="esEliminar"
                            >
                              <img
                                class="cursor-pointer mx-auto xs:w-4"
                                src="./assets/visibility_btn.svg"
                                alt="ver insumos"
                              />
                            </button>
                            <button
                              ngbTooltip="Ver Impuestos"
                              triggers="mouseenter:mouseleave"
                              [disabled]="esEliminar"
                              (click)="eliminarDetalle(detalle)"
                            >
                              <img
                                ngbTooltip="Eliminar detalle"
                                triggers="mouseenter:mouseleave"
                                class="cursor-pointer mx-auto xs:w-4"
                                src="assets/delete.svg"
                                alt="ver insumos"
                              />
                            </button>
                          </div>
                        </td>
                      </tr>
                    </ng-container>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div *ngIf="impuestosOpen" class="mt-2">
            <div class="rounded-lg shadow-md overflow-hidden">
              <div class="overflow-y-auto max-h-[150px] w-full">
                <table class="w-full text-sm">
                  <thead class="bg-primario text-white sticky top-0">
                    <tr>
                      <th class="px-1 py-[2px] w-[20%]" scope="col">
                        *Impuesto
                      </th>
                      <th class="px-1 py-[2px] w-[20%]" scope="col">*Factor</th>
                      <th class="px-1 py-[2px] w-[20%]" scope="col">
                        *Categoria
                      </th>
                      <th class="px-1 py-[2px] w-[20%]" scope="col">*Tasa</th>
                      <th class="px-1 py-[2px] w-[20%]" scope="col"></th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray300">
                    <ng-container
                      *ngFor="let impuesto of impuestosDetalleOrdenVenta"
                    >
                      <tr
                        class="font-medium text-gray700 hover:bg-gray200 animation duration-200 xs:text-[8px]"
                        (click)="selectedImpuesto = impuesto"
                      >
                        <td class="px-1 py-[2px]" scope="col">
                          <div class="relative w-full" #lista>
                            <input
                              type="text"
                              placeholder="Impuesto..."
                              autocomplete="off"
                              class="form-contrtrol w-full"
                              (click)="
                                mostrarListaImpuestos = !mostrarListaImpuestos
                              "
                              [(ngModel)]="impuesto.descripcionTipoImpuesto"
                              readonly
                              [disabled]="esEliminar"
                            />

                            <div
                              *ngIf="
                                mostrarListaImpuestos &&
                                impuesto.id == selectedImpuesto.id
                              "
                            >
                              <ul
                                class="fixed z-50 bg-white border border-gray-200 rounded-md mt-1 w-auto max-h-48 overflow-y-auto shadow-lg"
                              >
                                <li
                                  *ngFor="let tipo of tiposImpuesto"
                                  (click)="seleccionarImpuestos(tipo, impuesto)"
                                  class="px-4 py-2 cursor-pointer hover:bg-gray-100"
                                >
                                  {{ tipo.descripcionImpuesto }}
                                </li>
                              </ul>
                            </div>
                          </div>
                        </td>
                        <td class="px-1 py-[2px]" scope="col">
                          <div class="relative w-full" #lista>
                            <input
                              type="text"
                              placeholder="Factor..."
                              autocomplete="off"
                              class="form-contrtrol w-full"
                              (click)="
                                mostrarListaFactores = !mostrarListaFactores
                              "
                              [(ngModel)]="impuesto.descripcionTipoFactor"
                              readonly
                              [disabled]="esEliminar"
                            />

                            <div
                              *ngIf="
                                mostrarListaFactores &&
                                impuesto.id == selectedImpuesto.id
                              "
                            >
                              <ul
                                class="fixed z-50 bg-white border border-gray-200 rounded-md mt-1 w-auto max-h-48 overflow-y-auto shadow-lg"
                              >
                                <li
                                  *ngFor="let tipo of tiposFactor"
                                  (click)="seleccionarFactores(tipo, impuesto)"
                                  class="px-4 py-2 cursor-pointer hover:bg-gray-100"
                                >
                                  {{ tipo.descripcion }}
                                </li>
                              </ul>
                            </div>
                          </div>
                        </td>
                        <td class="px-1 py-[2px]" scope="col">
                          <div class="relative w-full" #lista>
                            <input
                              type="text"
                              placeholder="Categoria.."
                              autocomplete="off"
                              class="form-contrtrol w-full"
                              (click)="
                                mostrarListaCategoria = !mostrarListaCategoria
                              "
                              [(ngModel)]="
                                impuesto.descripcionCategoriaImpuesto
                              "
                              readonly
                              [disabled]="esEliminar"
                            />

                            <div
                              *ngIf="
                                mostrarListaCategoria &&
                                impuesto.id == selectedImpuesto.id
                              "
                            >
                              <ul
                                class="fixed z-50 bg-white border border-gray-200 rounded-md mt-1 w-auto max-h-48 overflow-y-auto shadow-lg"
                              >
                                <li
                                  *ngFor="let categoria of categoriaImpuesto"
                                  (click)="
                                    seleccionarCategorias(categoria, impuesto)
                                  "
                                  class="px-4 py-2 cursor-pointer hover:bg-gray-100"
                                >
                                  {{ categoria.tipo }}
                                </li>
                              </ul>
                            </div>
                          </div>
                        </td>
                        <td class="px-1 py-[2px]" scope="col">
                          <input
                            min="1"
                            placeholder="Categoria.."
                            autocomplete="off"
                            class="form-contrtrol w-full"
                            type="number"
                            data-bs-toggle="dropdown"
                            (keydown.enter)="agregarImpuesto(impuesto)"
                            [(ngModel)]="impuesto.tasaCuota"
                            [disabled]="esEliminar"
                          />
                        </td>
                        <td class="px-1 py-[2px]" scope="col">
                          <div class="flex">
                            <button
                              ngbTooltip="Ver Impuestos"
                              triggers="mouseenter:mouseleave"
                              [disabled]="esEliminar"
                              (click)="eliminarImpuesto(impuesto)"
                            >
                              <img
                                class="cursor-pointer mx-auto xs:w-4"
                                src="assets/delete.svg"
                                alt="ver insumos"
                              />
                            </button>
                          </div>
                        </td>
                      </tr>
                    </ng-container>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="px-4 py-3 flex justify-end gap-4">
          <!-- <button
            class="bg-colorButton hover:bg-colorButtonHover text-white py-2 px-4 rounded-md inline-flex justify-center shadow-sm ring-1 ring-inset transition-all"
            (click)="guardarOrdenVenta()"
          >
            Aceptar
          </button> -->
          <button
            class="bg-colorButton hover:bg-colorButtonHover text-white py-2 px-4 rounded-md inline-flex justify-center shadow-sm ring-1 ring-inset transition-all"
            (click)="closeModal()"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
